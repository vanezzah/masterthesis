---
title: "R Notebook"
output: html_notebook
---

Libraries: 

```{r}
#install.packages('mosaic')
#install.packages('data.table')
#install.packages('magrittr')
#install.packages('tidyr')
#install.packages('dplyr')


library(data.table)
library(magrittr)
library(tidyr)
library(dplyr)
library(mosaic)
```


Datenimport:

```{r}

HH_file<- file.path('Data/MiD2017_Haushalte.csv')
HH_dt <- fread(HH_file)
head(HH_dt)
HH_dt <- as.data.table(HH_dt)
str(HH_dt)


Person_file <- file.path('Data/MiD2017_Personen.csv')
Person_dt <- fread(Person_file)
Person_dt <- as.data.table(Person_dt)
head(Person_dt)

```


# Überprüfen Haushalts IDs mit PersonenIDs
# zu jedem Haushalt gibt es Personen
```{r}
ids_HH <- HH_dt[, "H_ID"] # 156240
ids_P <- Person_dt[, "H_ID"]
unique_ids_P <- unique(ids_P) # 156240
count(unique_ids_P)
count(ids_HH)
```

# Wie viele Haushalte mit 1,2,3,4 autos gibt es: 
```{r}
dplyr::count(HH_dt, anzauto_gr1)
3424/156420
# nur ca. 2 % der HH haben 4 Autos und mehr -> es reicht die Untergliederung bis 3 und mehr Autos zu verwenden 
```

Wieviele Haushalte machen keine Angabe:

```{r}
dplyr::count(HH_dt, auto)
```
14 Haushalte machen keine Angabe --> aus Datensatz entfernen :

```{r}

HH_dt <- filter(HH_dt, anzauto_gr2 != 9 )
```


Spalten aus HH_dt löschen die nicht benötigt werden 

```{r}
HH_dt[, c("H_GEW","H_HOCH"):=NULL]
# Gründe für nicht Besitz, pkw segment, bundesland, andere variablen zu einkommen (71-77), pkw_jahresfl)
HH_dt <- HH_dt[, -c(62:66,86,87,90,91,71:73, 75:77, 88)]
HH_dt[, c("MODE","BASISAUF", "TEILSTP", "H_NEBEN_1","H_NEBEN_2","H_NEBEN_3","H_NEBEN_4","H_NEBEN_5", "H_NEBEN_6", "H_NEBEN_7","H_NEBEN_8", "anzneben", "nebenws", "H_NOCAR_A" ):=NULL]
HH_dt[, "hausnutz":=NULL]
HH_dt[, "wohnlage":=NULL]
HH_dt[, c("RegioStaR2","RegioStaR17"):=NULL]
HH_dt[, "H_MIETE":=NULL]
HH_dt[, "H_ART":=NULL]
# Geschlecht
HH_dt <- HH_dt[, -c(5:12)]
#andere anz_auto infos
HH_dt[, c("anzauto_gr1","anzauto_gr3"):=NULL]
HH_dt[, "H_ANZAUTO":= NULL]
# nur auto ja oder nein 
HH_dt[, "M_CAR":= NULL]
```

Daten aus Personenset hinzuziehen: 

1. Höchster Bildungsabschluss

```{r}
bildung_dt <- Person_dt[, c("H_ID", "P_BIL")]
Anzahl_HH <- unique(bildung_dt[, "H_ID"])
count(Anzahl_HH)
bildung_ohneProxy <- bildung_dt[P_BIL != "206" & P_BIL!= "9"]
Anzahl_HH_ohneProxy <- unique(bildung_ohneProxy[, "H_ID"])
count(Anzahl_HH_ohneProxy)

maxbildung_byHH <- max(P_BIL ~ H_ID, data = bildung_ohneProxy)
maxbildung_dt <- as.data.table(data.frame(HH_ID=names(maxbildung_byHH), maxBildung=maxbildung_byHH, row.names=NULL))
str(maxbildung_dt)

dplyr::count(maxbildung_dt, maxBildung)
## 6 ( = anderer Abschluss)?


mean(maxbildung_dt$maxBildung) 
# damit ersetzen?


```

2. Anzahl Wege insgesamt am Stichtag

```{r}
#anzwege2 sind die Anzahl Wege insgesamt (inkl. weiterer Wege aber ohne rbw(busfahrer etc.))
Wege_dt <- Person_dt[, c("H_ID", "anzwege2", "arbwo", "feiertag")]

#nur Personen mit bekannter Mobilität bzw. wegeerfassung
Wege_clean <- Wege_dt[anzwege2 != "803" & anzwege2!= "804"]

#nur Personen der Stichtag ein Wochentag war
Wege_Wochentage <- Wege_clean[arbwo == 1 & feiertag == 0]

x <- sum(anzwege2 ~ H_ID, data = Wege_Wochentage)
anzahlWege_dt <- as.data.table(data.frame(HH_ID=names(x), anzahlWege=x, row.names=NULL))
dplyr::count(anzahlWege_dt, anzahlWege)

unique(anzahlWege_dt$HH_ID)
# noch ca. 100.000 HH vorhanden
summary(anzahlWege_dt)
# sehr hohe Werte rausnehmen ? 60?

#wie mit jetzt fehlenden haushalten umgehen -> einfach raus oder imputieren?
```

3. Länge der Wege am Stichtag

```{r}
#perskm2 enthält länge aller wege mit weiteren wegen ohne rbw, fehlende werte wurden imputiert
Weglänge_dt <- Person_dt[, c("H_ID", "perskm2", "arbwo", "feiertag")]

summary(Weglänge_dt)
Weglänge_dt$perskm2

# wie mit "80802 - person hat nur rbw" umgehen? -> raus ca. 2600

Weglänge_clean <- Weglänge_dt[perskm2 != "80803" & perskm2!= "80804"]

# perskm2 is a character column, we need to convert it to numeric to be able to sum it up
Weglänge_clean$perskm2 <- sub("," , ".", Weglänge_clean$perskm2)
Weglänge_clean$perskm2 <- as.numeric(Weglänge_clean$perskm2)

summary(Weglänge_clean)


x <- sum(perskm2 ~ H_ID, data = Weglänge_clean)
gesamteWeglänge_dt <- as.data.table(data.frame(HH_ID=names(x), perskm2=x, row.names=NULL))
dplyr::count(gesamteWeglänge_dt, perskm2)

unique(gesamteWeglänge_dt$HH_ID)

```

Alle 3 Merkmale zusammen in eine data table

```{r}
#1. maxBildung_dt 
# 4600 Leute mit anderer Bildung ?

#2. anzahlWege_dt

combined2_df <- merge(x=maxbildung_dt,y=anzahlWege_dt,by="HH_ID")

#3. gesamteWeglänge_dt

combined3_df <- merge(x=combined_df, y=gesamteWeglänge_dt, by="HH_ID")
```

Anzahl berufstätiger Personen im HH

HP_TAET_1 bis HP_TAET_8

berufstätig:
1: Vollzeit berufstätig
2: Teilzeit berufstätig, d.h. 18 bis unter 35 Stunden pro Woche
3: geringfügig beschäftigt
4: berufstätig als Nebentätigkeit oder im Praktikum
5: berufstätig ohne Angabe zum Umfang

```{r}

taet_dt <- HH_dt[, 13:20]
taet_dt[, "berufstaetige"] <- 0
taet_dt$berufstaetige <- as.numeric(taet_dt$berufstaetige)
summary(taet_dt)
taet_dt <- as.data.table(taet_dt)

# temp vector
res <- numeric(nrow(taet_dt))

cols <- c(1:8)
rows <- c(1:nrow(taet_dt))
for (row in rows){
  for (col in cols) {
      if (taet_dt[row, ..col] == 1 || taet_dt[row, ..col] == 2 || taet_dt[row, ..col] == 3 ||taet_dt[row, ..col] == 4    ||taet_dt[row, ..col] == 5) {
  res[row] <- res[row] + 1
     
      
      #set(taet_dt[row], j = "berufstaetige", value = taet_dt[row, "berufstaetige"] + 1)
    #taet_dt[row, "berufstaetige"] <- taet_dt[row, "berufstaetige"] +1
    
    }
    
  }
  
} 

#taet_dt[1:50, lapply(.SD, function(x) { 
##  if (x == 1 ||x == 2 || x == 3 ||x == 4 || x == 5) {
 #     taet_dt[, "berufstaetige"] <- taet_dt[i, "berufstaetige"] +1
      #taet_dt[row, "berufstaetige"] <- taet_dt[row, "berufstaetige"] + 1
  #  } 
  #}),.SDcols = c(1:8)] 

# an HH_dt anschliessen 

HH_dt$berufstaetige <- res

# taetigkeitsspalten raus
HH_dt <- HH_dt[, -c(13:20)]
  
```

Anzahl Führerscheinbesitzer

```{r}
HH_dt <- filter(HH_dt, HP_ANZFS != 99 &HP_ANZFS != 94 )
dplyr::count(HH_dt, HP_ANZFS)

# entfernen Spalte anzfs in gruppen
HH_dt[, "anzfs_gr":= NULL]
```

HH-Größe

```{r}
HH_dt <- as.data.table(HH_dt)
HH_dt[, "hhgr_gr":= NULL]
setnames(HH_dt, "H_GR", "hhsize")
```


Alter der Haushaltsmitglieder

```{r}

#NOCH 999 entfernen (nächster Durchlauf)!
HH_dt <- filter(HH_dt, HP_ALTER_1 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_2 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_3 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_4 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_5 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_6 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_7 != 999 )
HH_dt <- filter(HH_dt, HP_ALTER_8 != 999 )


alter_dt <- HH_dt[, 2:10]
alter_dt[, "share2039"] <- 0
alter_dt[, "share4064"] <- 0
alter_dt[, "share65"] <- 0

summary(alter_dt)
is.data.table(alter_dt)
# alle numerisch und ist data table

# für 20-39 jährige:
temp <- alter_dt[,2:9]

result <- temp < 40 & temp > 19
result <- as.data.table(result)
result <- result*1
result
anzahl2039 <- apply(result,1,sum)
share2039 <- anzahl2039/ alter_dt[,1]
alter_dt$share2039 <- share2039

# für > 65 jährige

result2 <- temp > 65 & temp < 150
result2 <- as.data.table(result2)
result2 <- result2*1
anzahl65 <- apply(result2,1,sum)
share65 <- anzahl65/ alter_dt[,1]
alter_dt$share65 <- share65

# für 40 - 64 jährige

result3 <- temp < 65 & temp > 39
result3 <- as.data.table(result3)
result3 <- result3*1
anzahl4064 <- apply(result3,1,sum)
share4064 <- anzahl4064/ alter_dt[,1]
alter_dt$share4064 <- share4064

HH_dt[, "share2039"] <- 0
HH_dt[, "share4064"] <- 0
HH_dt[, "share65"] <- 0

HH_dt$share2039 <- share2039
HH_dt$share4064 <- share4064
HH_dt$share65 <- share65

HH_dt <- HH_dt[, -c(3:10)]

```

Household lifecycle stage / children?

 (a) single (1 if household consists of one member, 0 otherwise), (b) couple, (c) couple with children, (d) single parent (1 if the household consists of 1 adult and one or more children, 0 otherwise) and (e) extended families or unattached individuals. 
 
hhtyp : 1 - 11
95 rauswerfen 

1: 18-29
2:1-Personen-HH: Person 30-59 Jahre 
3:1-Personen-HH: Person 60 Jahre und älter -> single
4:2-Personen-HH: jüngste Person 18-29 Jahre
5:2-Personen-HH: jüngste Person 30-59 Jahre
6:2-Personen-HH: jüngste Person 60 Jahre und älte->couple
7:HH mit mind. 3 Erwachsenen -> extended family
8:HH mit mind. einem Kind unter 6 Jahren 
9:HH mit mind. einem Kind unter 14 Jahren 
10:HH mit mind. einem Kind unter 18 Jahren -> couple with children
11:Alleinerziehende(r) -> single parent
95:nicht zuzuordnen

```{r}
HH_dt <- filter(HH_dt, hhtyp != 95 )

hhtyp_dt <- HH_dt[, 26]
hhtyp_dt <- as.data.table(hhtyp_dt)
hhtyp_dt[, "single"] <- 0
hhtyp_dt[, "couple"] <- 0
hhtyp_dt[, "couple_children"] <- 0
hhtyp_dt[, "singleparent"] <- 0
hhtyp_dt[, "otherindividuals"] <- 0


# Singles
temp2 <- hhtyp_dt[,1]

single <- temp2 < 4
single <- as.data.table(single)
single <- single*1
hhtyp_dt$single <- single

# Couples

couple <- temp2 < 7 & temp2 > 3
couple <- as.data.table(couple)
couple <- couple *1
hhtyp_dt$couple <- couple 

# Couples with children

couple_c <- temp2 < 11 & temp2 > 7
couple_c <- as.data.table(couple_c)
couple_c <- couple_c*1
hhtyp_dt$couple_children <- couple_c

# singleparent

singleparent <- temp2 == 11
singleparent <- as.data.table(singleparent)
singleparent <- singleparent*1
hhtyp_dt$singleparent <- singleparent

# otherindividuals

others <- temp2 == 7
others <- as.data.table(others)
others <- others*1
hhtyp_dt$otherindividuals <- others

#anhängen 

HH_dt[, "single"] <- 0
HH_dt[, "couple"] <- 0
HH_dt[, "couple_children"] <- 0
HH_dt[, "single_parent"] <- 0
HH_dt[, "other_ind"] <- 0

HH_dt[, "single"] <- single
HH_dt[, "couple"] <- couple
HH_dt[, "couple_children"] <- couple_c
HH_dt[, "single_parent"] <- singleparent
HH_dt[, "other_ind"] <- others

HH_dt <- as.data.table(HH_dt)
HH_dt[, "hhtyp":= NULL]
HH_dt[, "hhtyp2":= NULL]
```

Anzahl andere Fortbewegungsmittel

Gebäudetyp

ÖPNV Variablen

subjektive zufriedenheit öpnv (korreliert mit quali_öpnv?)

Gebäudetyp

Carsharing
